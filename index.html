<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الاجتماعات</title>
    <!-- تضمين Tailwind CSS من CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- تضمين مكتبات Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // متغيرات Firebase ستكون متاحة بشكل عام
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
    </script>
    <style>
        /* استيراد خط Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* تطبيق السمة الداكنة على كامل الصفحة */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* خلفية داكنة جداً */
            color: #d1d5db; /* لون نص فاتح */
            direction: rtl;
            text-align: right;
            transition: background-color 0.5s ease-in-out;
            min-height: 100vh;
        }

        /* تنسيق الحاوية الرئيسية للاستجابة على جميع الشاشات */
        .container {
            max-width: 1024px;
            margin: 0 auto;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        /* تنسيق بطاقة (Card) التطبيق */
        .card {
            background-color: #1f2937; /* خلفية البطاقة أغمق قليلاً من النص */
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            width: 100%;
        }

        /* تنسيق حقول الإدخال */
        .form-input {
            width: 100%;
            padding: 0.8rem 1.25rem;
            border: 1px solid #4b5563; /* لون حدود مناسب للخلفية الداكنة */
            border-radius: 0.75rem;
            transition: all 0.3s ease-in-out;
            background-color: #374151;
            color: #f9fafb;
        }
        .form-input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.25);
            background-color: #1f2937;
        }
        .form-input::placeholder {
            color: #9ca3af;
        }

        /* تنسيق الأزرار */
        .btn {
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.5;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }
        .btn-green {
            background-color: #10b981;
            color: white;
        }
        .btn-green:hover {
            background-color: #059669;
        }
        .btn-red {
            background-color: #ef4444;
            color: white;
        }
        .btn-red:hover {
            background-color: #dc2626;
        }
        .btn-gray {
            background-color: #4b5563;
            color: white;
        }
        .btn-gray:hover {
            background-color: #6b7280;
        }

        /* تنسيق الجدول */
        .table-header th {
            padding: 1.25rem 1rem;
            background-color: #374151; /* لون أغمق قليلاً من الخلفية */
            color: #d1d5db;
            font-weight: 700;
            font-size: 0.875rem;
            text-align: right;
            border-bottom: 2px solid #374151;
        }
        .table-row td {
            padding: 1rem;
            border-bottom: 1px solid #374151;
            vertical-align: middle;
        }
        .table-row:hover {
            background-color: #2e3540;
        }

        /* تنسيق نافذة التأكيد (Modal) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.75);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 450px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        
        /* تنسيق دوران التحميل */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div class="container">

    <!-- قائمة الاجتماعات -->
    <div id="list-view" class="card hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-white">إدارة الاجتماعات</h1>
            <div class="text-sm text-gray-400">
                <span class="font-semibold">هويتك:</span> <span id="user-id-display">...</span>
            </div>
        </div>
        <div class="text-center mb-8">
            <button id="add-meeting-btn" class="btn btn-primary text-lg">
                <span class="ml-2">➕</span> إضافة اجتماع جديد
            </button>
        </div>
        <div id="loading-spinner" class="flex justify-center items-center py-10">
            <div class="spinner"></div>
        </div>
        <div id="table-container" class="overflow-x-auto rounded-lg shadow-inner bg-gray-800 hidden">
            <table class="min-w-full">
                <thead>
                    <tr class="table-header">
                        <th>عنوان الاجتماع</th>
                        <th>التاريخ</th>
                        <th>الوقت</th>
                        <th>المكان</th>
                        <th>الحضور</th>
                        <th class="text-left">الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="meetings-table-body">
                    <!-- سيتم إضافة صفوف الاجتماعات هنا بواسطة JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- نموذج إضافة/تعديل اجتماع -->
    <div id="add-edit-view" class="card hidden">
        <h2 id="form-title" class="text-3xl font-bold text-center mb-8 text-white">إضافة اجتماع جديد</h2>
        <form id="meeting-form" class="space-y-6">
            <input type="hidden" id="meeting-id">
            <div>
                <label for="title" class="block text-gray-400 font-semibold mb-2">عنوان الاجتماع</label>
                <input type="text" id="title" name="title" class="form-input" required>
            </div>
            <div>
                <label for="date-time" class="block text-gray-400 font-semibold mb-2">التاريخ والوقت</label>
                <div class="flex gap-4">
                    <input type="date" id="date" name="date" class="form-input" required>
                    <input type="time" id="time" name="time" class="form-input" required>
                </div>
            </div>
            <div>
                <label for="location" class="block text-gray-400 font-semibold mb-2">المكان (أو رابط الاجتماع)</label>
                <input type="text" id="location" name="location" class="form-input" required>
            </div>
            <div>
                <label for="attendees" class="block text-gray-400 font-semibold mb-2">قائمة الحضور (افصل بين الأسماء بفاصلة)</label>
                <textarea id="attendees" name="attendees" rows="4" class="form-input" placeholder="مثال: أحمد, سارة، محمد"></textarea>
            </div>
            <div class="flex justify-center gap-4 mt-8">
                <button type="submit" class="btn btn-green">حفظ الاجتماع</button>
                <button type="button" id="cancel-form-btn" class="btn btn-gray">إلغاء</button>
            </div>
        </form>
    </div>

    <!-- تفاصيل الاجتماع -->
    <div id="view-details-view" class="card hidden">
        <h2 class="text-3xl font-bold text-center mb-8 text-white">تفاصيل الاجتماع</h2>
        <div class="space-y-6 text-gray-300 text-lg">
            <p><span class="font-bold text-white">عنوان الاجتماع:</span> <span id="view-title"></span></p>
            <p><span class="font-bold text-white">التاريخ:</span> <span id="view-date"></span></p>
            <p><span class="font-bold text-white">الوقت:</span> <span id="view-time"></span></p>
            <p><span class="font-bold text-white">المكان:</span> <span id="view-location"></span></p>
            <div>
                <span class="font-bold text-white block mb-2">الحضور:</span>
                <ul id="view-attendees" class="list-disc pr-6 space-y-1"></ul>
            </div>
        </div>
        <div class="flex justify-center gap-4 mt-8">
            <button id="edit-details-btn" class="btn btn-primary">تعديل</button>
            <button id="end-meeting-btn" class="btn btn-red">إنهاء الاجتماع</button>
            <button id="back-to-list-btn" class="btn btn-gray">العودة للقائمة</button>
        </div>
    </div>
    
    <!-- نافذة تأكيد مخصصة -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <p id="modal-message" class="text-xl text-white mb-6 font-semibold"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes-btn" class="btn btn-red">نعم</button>
                <button id="confirm-no-btn" class="btn btn-gray">إلغاء</button>
            </div>
        </div>
    </div>

</div>

<script type="module">
    // تهيئة Firebase
    let db, auth, userId;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // عناصر الواجهة الرسومية
    const listMeetingsView = document.getElementById('list-view');
    const addEditMeetingView = document.getElementById('add-edit-view');
    const viewDetailsView = document.getElementById('view-details-view');
    const meetingsTableBody = document.getElementById('meetings-table-body');
    const addMeetingBtn = document.getElementById('add-meeting-btn');
    const meetingForm = document.getElementById('meeting-form');
    const formTitle = document.getElementById('form-title');
    const cancelFormBtn = document.getElementById('cancel-form-btn');
    const backToListBtn = document.getElementById('back-to-list-btn');
    const endMeetingBtn = document.getElementById('end-meeting-btn');
    const editDetailsBtn = document.getElementById('edit-details-btn');
    const confirmModal = document.getElementById('confirm-modal');
    const modalMessage = document.getElementById('modal-message');
    const confirmYesBtn = document.getElementById('confirm-yes-btn');
    const confirmNoBtn = document.getElementById('confirm-no-btn');
    const userIdDisplay = document.getElementById('user-id-display');
    const loadingSpinner = document.getElementById('loading-spinner');
    const tableContainer = document.getElementById('table-container');

    let meetings = [];
    let currentMeetingId = null;
    let isDataLoaded = false;

    // دالة لتشغيل Firebase ومصادقة المستخدم
    async function setupFirebase() {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // مصادقة المستخدم باستخدام الرمز المخصص أو كمستخدم مجهول
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    // بعد المصادقة، ابدأ في الاستماع للتغييرات في قاعدة البيانات
                    listenForMeetings();
                } else {
                    console.error("User not authenticated.");
                    userIdDisplay.textContent = 'خطأ في المصادقة';
                }
            });

        } catch (error) {
            console.error("Error setting up Firebase:", error);
            alert("حدث خطأ أثناء تهيئة التطبيق. يرجى إعادة المحاولة.");
        }
    }

    // دالة للاستماع للتغييرات في الاجتماعات في الوقت الفعلي
    function listenForMeetings() {
        if (!db || !userId) {
            return;
        }
        const userMeetingsRef = collection(db, `artifacts/${appId}/users/${userId}/meetings`);
        onSnapshot(userMeetingsRef, (snapshot) => {
            meetings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            isDataLoaded = true;
            renderMeetingsTable();
        });
    }

    // دالة للتبديل بين الصفحات
    function showView(view) {
        listMeetingsView.classList.add('hidden');
        addEditMeetingView.classList.add('hidden');
        viewDetailsView.classList.add('hidden');
        
        let activeView;
        if (view === 'list') {
            activeView = listMeetingsView;
            if (isDataLoaded) {
                renderMeetingsTable();
            } else {
                loadingSpinner.classList.remove('hidden');
                tableContainer.classList.add('hidden');
            }
        } else if (view === 'add-edit') {
            activeView = addEditMeetingView;
        } else if (view === 'view-details') {
            activeView = viewDetailsView;
        }
        
        if (activeView) {
            activeView.classList.remove('hidden');
        }
    }

    // دالة لعرض جدول الاجتماعات
    function renderMeetingsTable() {
        loadingSpinner.classList.add('hidden');
        tableContainer.classList.remove('hidden');
        meetingsTableBody.innerHTML = '';
        if (meetings.length === 0) {
            meetingsTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-400">لا توجد اجتماعات مجدولة.</td></tr>`;
            return;
        }

        meetings.forEach(meeting => {
            const row = document.createElement('tr');
            row.className = 'table-row';
            row.innerHTML = `
                <td>${meeting.title}</td>
                <td>${meeting.date}</td>
                <td>${meeting.time}</td>
                <td>${meeting.location}</td>
                <td>${(meeting.attendees || '').split(',').filter(Boolean).length}</td>
                <td class="flex gap-2">
                    <button class="text-blue-400 hover:text-blue-200 transition-colors" onclick="viewMeeting('${meeting.id}')">عرض</button>
                    <button class="text-green-400 hover:text-green-200 transition-colors" onclick="editMeeting('${meeting.id}')">تعديل</button>
                    <button class="text-red-400 hover:text-red-200 transition-colors" onclick="confirmAction('${meeting.id}', 'delete')">حذف</button>
                </td>
            `;
            meetingsTableBody.appendChild(row);
        });
    }

    // دالة لعرض تفاصيل اجتماع
    function viewMeeting(id) {
        const meeting = meetings.find(m => m.id === id);
        if (meeting) {
            document.getElementById('view-title').textContent = meeting.title;
            document.getElementById('view-date').textContent = meeting.date;
            document.getElementById('view-time').textContent = meeting.time;
            document.getElementById('view-location').textContent = meeting.location;
            const attendeesList = document.getElementById('view-attendees');
            attendeesList.innerHTML = '';
            (meeting.attendees || '').split(',').filter(Boolean).forEach(attendee => {
                const li = document.createElement('li');
                li.textContent = attendee.trim();
                attendeesList.appendChild(li);
            });
            currentMeetingId = id;
            showView('view-details');
        }
    }
    
    // دالة لإظهار نافذة التأكيد
    function confirmAction(id, actionType) {
        confirmModal.style.display = 'flex';
        confirmYesBtn.textContent = (actionType === 'delete') ? 'نعم، احذف' : 'نعم، قم بالإنهاء';
        modalMessage.textContent = (actionType === 'delete') ? 'هل أنت متأكد أنك تريد حذف هذا الاجتماع؟' : 'هل أنت متأكد أنك تريد إنهاء هذا الاجتماع؟';
        
        confirmYesBtn.onclick = async () => {
            if (actionType === 'delete') {
                await deleteMeeting(id);
                showView('list');
            } else {
                await deleteMeeting(currentMeetingId);
                showView('list'); // العودة للقائمة بعد الإنهاء
            }
            confirmModal.style.display = 'none';
        };

        confirmNoBtn.onclick = () => {
            confirmModal.style.display = 'none';
        };
    }

    // دالة لحذف اجتماع من Firestore
    async function deleteMeeting(id) {
        if (!db || !userId) return;
        const meetingRef = doc(db, `artifacts/${appId}/users/${userId}/meetings`, id);
        try {
            await deleteDoc(meetingRef);
        } catch (e) {
            console.error("Error deleting meeting: ", e);
        }
    }

    // دالة لتعبئة النموذج ببيانات اجتماع للتعديل
    function editMeeting(id) {
        const meeting = meetings.find(m => m.id === id);
        if (meeting) {
            formTitle.textContent = 'تعديل الاجتماع';
            document.getElementById('meeting-id').value = meeting.id;
            document.getElementById('title').value = meeting.title;
            document.getElementById('date').value = meeting.date;
            document.getElementById('time').value = meeting.time;
            document.getElementById('location').value = meeting.location;
            document.getElementById('attendees').value = meeting.attendees;
            showView('add-edit');
        }
    }

    // معالجة الأحداث
    document.addEventListener('DOMContentLoaded', () => {
        setupFirebase();
        showView('list');
    });

    addMeetingBtn.addEventListener('click', () => {
        formTitle.textContent = 'إضافة اجتماع جديد';
        meetingForm.reset();
        document.getElementById('meeting-id').value = '';
        showView('add-edit');
    });

    cancelFormBtn.addEventListener('click', () => {
        showView('list');
    });

    backToListBtn.addEventListener('click', () => {
        showView('list');
    });

    editDetailsBtn.addEventListener('click', () => {
        editMeeting(currentMeetingId);
    });

    endMeet
